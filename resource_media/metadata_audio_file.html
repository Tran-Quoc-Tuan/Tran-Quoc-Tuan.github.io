<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sưu tập hình nền</title>

    <!-- Custom style -->
    <link rel="stylesheet" href="../static/css/style.css">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="../https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet" href="../plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="../plugins/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="../plugins/jqvmap/jqvmap.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../dist/css/adminlte.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="../plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="../plugins/daterangepicker/daterangepicker.css">
    <!-- summernote -->
    <link rel="stylesheet" href="../plugins/summernote/summernote-bs4.min.css">
    <!-- Dropzone -->
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>

<body>
    <div class="wrapper">

        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- Left navbar links -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="../index.html" class="nav-link">Trang chủ</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block nav-item-active">
                    <a href="background.html" class="nav-link">Tài nguyên đa phương tiện</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Blog</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="../my_github.html" class="nav-link">Github cá nhân</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Bookmark</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Một chút về sách</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Thử nghiệm</a>
                </li>
            </ul>
        </nav>
        <!-- /.navbar -->

        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Sidebar Menu -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                        data-accordion="false">
                        <!-- Add icons to the links using the .nav-icon class
                   with font-awesome or any other icon font library -->
                        <li class="nav-item">
                            <a href="../index.html" class="nav-link">
                                <i class="nav-icon fas fa-home"></i>
                                Trang chủ
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link active">
                                <i class="nav-icon fas fa-photo-video"></i>
                                <p>
                                    Tài nguyên đa phương tiện
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="./background.html" class="nav-link">
                                        <i class="far nav-icon"></i>
                                        <p>Hình nền</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="./metadata_audio_file.html" class="nav-link active">
                                        <i class="far nav-icon"></i>
                                        <p>Siêu dữ liệu file âm thanh</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-blog"></i>
                                <p>
                                    Blog
                                    <i class="right fas fa-angle-left"></i>
                                </p>
                            </a>
                            <ul class="nav nav-treeview">
                                <li class="nav-item">
                                    <a href="./index.html" class="nav-link">
                                        <i class="far nav-icon"></i>
                                        <p>Mới nhất</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="./index2.html" class="nav-link">
                                        <i class="far nav-icon"></i>
                                        <p>Series</p>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a href="./index2.html" class="nav-link">
                                        <i class="far nav-icon"></i>
                                        <p>Chủ đề</p>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a href="../my_github.html" class="nav-link">
                                <i class="nav-icon fab fa-github"></i>
                                Trang Github cá nhân
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="nav-icon fas fa-bookmark"></i>
                                Bookmark
                                </p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="index.html" class="nav-link">
                                <i class="nav-icon fas fa-flask"></i>
                                Các tính năng thử nghiệm
                                </p>
                            </a>
                        </li>
                    </ul>
                </nav>
                <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
        </aside>

        <div class="content-wrapper">
            <section class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1>Siêu dữ liệu file âm thanh</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Tài nguyên đa phương tiện</a></li>
                                <li class="breadcrumb-item active">Siêu dữ liệu file âm thanh</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- notifycation -->
            <!-- <div class="info-box bg-success">
                <div class="info-box-content">
                    <span class="info-box-text">Chức năng đang trong quá trình phát triển, sẽ sớm ra mắt!</span>
                </div>
            </div> -->

            <div id="content" class="container-fluid">
                <!-- upload file -->
                <div id="upload" class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tải lên file</h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <blockquote class="quote-danger">
                            <h5 id="note">Lưu ý!</h5>
                            <p class="font-weight-light font-italic">
                                Hiện tại chỉ hỗ trợ định dạng flac, các định dạng khác sẽ được cập nhật trong thời gian
                                sớm nhất
                            </p>
                        </blockquote>
                        <form method="post" action="http://127.0.0.1:5000/read-metadata-audio" class="dropzone" id="drop-audio-file"
                            enctype="multipart/form-data">
                            <div class="dz-message" data-dz-message>Thả file tại đây</div>
                            <!-- <div class="fas fa-trash text-danger" data-dz-remove></div> -->
                        </form>
                        <div class="submit btn btn-primary mt-2">Tải lên</div>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
        </div>

    </div>

    <!-- jQuery -->
    <script src="../plugins/jquery/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="../plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
    <script>
        $.widget.bridge('uibutton', $.ui.button)
    </script>
    <!-- Bootstrap 4 -->
    <script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- ChartJS -->
    <script src="../plugins/chart.js/Chart.min.js"></script>
    <!-- Sparkline -->
    <script src="../plugins/sparklines/sparkline.js"></script>
    <!-- JQVMap -->
    <script src="../plugins/jqvmap/jquery.vmap.min.js"></script>
    <script src="../plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
    <!-- jQuery Knob Chart -->
    <script src="../plugins/jquery-knob/jquery.knob.min.js"></script>
    <!-- daterangepicker -->
    <script src="../plugins/moment/moment.min.js"></script>
    <script src="../plugins/daterangepicker/daterangepicker.js"></script>
    <!-- Tempusdominus Bootstrap 4 -->
    <script src="../plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <!-- Summernote -->
    <script src="../plugins/summernote/summernote-bs4.min.js"></script>
    <!-- overlayScrollbars -->
    <script src="../plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <!-- AdminLTE App -->
    <script src="../dist/js/adminlte.js"></script>
    <!-- Dropzone -->
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="../static/js/script.js"></script>

    <script>
        $('select').select2();

        var fileHandling, responseData;
        Dropzone.options.dropAudioFile = {
            maxFiles: 1,
            parallelUploads: 1,
            autoProcessQueue: false,
            addRemoveLinks: true,
            method: 'post',
            acceptedFiles: 'audio/flac',
            dictRemoveFile: '<span class="fas fa-trash text-danger mt-1" role="button" data-dz-remove></span>',
            success: function (file, response) {
                responseData = JSON.parse(response);
                generalFLACMetadataCard(responseData);
                enableCard();
            },
            init: function () {
                let dropZone = this;

                this.on("complete", file => {
                    this.removeFile(file);
                });

                this.on("maxfilesexceeded", file => {
                    alert('Chỉ được chọn 1 file mỗi lần thôi!');
                });

                document.querySelector("div.submit").addEventListener("click", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!dropZone.files.length) {return;}

                    fileHandling = dropZone.files[0];
                    $('#upload').append(generalLoadScreen());
                    $('#metadata').remove();
                    dropZone.processQueue();
                    // dropZone.removeAllFiles();
                });
            }
        };

        const sampleData = {
            file: {
                name: null,
                type: 'flac',
                length: NaN,
                size: NaN,
                stream_info: {
                    minimum_block_size: 1000,
                    maximum_block_size: 1000,
                    sample_rate: 44100,
                    bit_rate: 985,
                    channels: 2,
                    sample_size: 16,
                },
            },
            metadata: {
                title: 'Aoi Shiori',
                artist: 'Galileo Galilei',
                album: '青い栞',
                date: NaN,
                track_number: 1,
                total_tracks: 3,
                genre: null
            },
            pictures: [
                {
                    type: null,
                    desciption: null,
                    data: null
                }
            ]
        };

        function generalFLACMetadataCard(metadata) {
            const content = `
                <!-- metadata -->
                <div id="metadata" class="card">
                    <div class="card-header">
                        <h3 class="card-title">Dữ liệu</h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <div class="container-fluid">
                            ${generalFLACFileInfoTable(metadata.file)}
                            ${generalFLACFileTagsTable(metadata.metadata)}
                            ${generalPicturesElement(metadata.pictures)}
                        </div>
                    </div>
                    <!-- /.card-body -->
                    <div class="card-footer">
                        <div class="btn btn-primary mt-2" onclick="btnEditClick()">Chỉnh sửa</div>
                    </div>
                    <!-- /.card-footer -->
                </div>
                <!-- /.card -->
            `;
            $('#content').append(content);
        }

        function generalFLACFileInfoTable(fileInfo = sampleData.file) {
            return `
                <div class="row">
                    <table class="table table-hover table-dark">
                        <tr>
                            <th scope="row">Tên</th>
                            <td>${fileInfo.name}</td>
                        </tr>
                        <tr>
                            <th scope="row">Định dạng</th>
                            <td>${fileInfo.type}</td>
                        </tr>
                        <tr>
                            <th scope="row">Độ dài</th>
                            <td>${fileInfo.length}</td>
                        </tr>
                        <tr>
                            <th scope="row">Kích thước block lớn nhất</th>
                            <td>${fileInfo.stream_info.minimum_block_size}</td>
                        </tr>
                        <tr>
                            <th scope="row">Kích thước block nhỏ nhất</th>
                            <td>${fileInfo.stream_info.maximum_block_size}</td>
                        </tr>
                        <tr>
                            <th scope="row">Tỉ lệ mẫu</th>
                            <td>${fileInfo.stream_info.sample_rate}</td>
                        </tr>
                        <tr>
                            <th scope="row">Tốc độ truyền</th>
                            <td>${fileInfo.stream_info.bit_rate}</td>
                        </tr>
                        <tr>
                            <th scope="row">Số kênh</th>
                            <td>${fileInfo.stream_info.channels}</td>
                        </tr>
                        <tr>
                            <th scope="row">Kích thước mẫu</th>
                            <td>${fileInfo.stream_info.sample_size}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generalFLACFileTagsTable(fileTags) {
            console.log(fileTags);
            return `
                <div class="row">
                    <table class="table table-hover table-dark">
                        <tr>
                            <th scope="row">Tên</th>
                            <td>${fileTags.title}</td>
                        </tr>
                        <tr>
                            <th scope="row">Nghệ sĩ</th>
                            <td>${fileTags.artist}</td>
                        </tr>
                        <tr>
                            <th scope="row">Album</th>
                            <td>${fileTags.album}</td>
                        </tr>
                        <tr>
                            <th scope="row">Số thứ tự / tổng số bài trong album </th>
                            <td>${fileTags.tracknumber ? fileTags.tracknumber : 'Không rõ'}/${fileTags.totaltracks ? fileTags.totaltracks : 'Không rõ'}</td>
                        </tr>
                        <tr>
                            <th scope="row">Năm phát hành</th>
                            <td>${fileTags.date ? fileTags.date : 'Không rõ'}</td>
                        </tr>
                        <tr>
                            <th scope="row">Thể loại</th>
                            <td>${fileTags.genre ? fileTags.genre : 'Không rõ'}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generalPicturesElement(pictures = sampleData.pictures) {
            return `
                <div class="container-fluid">
                    <div class="row row-cols-5">
                        ${generalPicturesCard(pictures)}
                    </div>
                </div>
            `;
        }

        function generalPicturesCard(pictures = sampleData.pictures) {
            picturesCard = '';

            for (i = 0; i < pictures.length; i++) {
                pictureCard = generalPictureCard(pictures[i]);
                picturesCard += pictureCard;
            }
            return picturesCard;
        }

        function generalPictureCard(picture = sampleData.pictures[0]) {
            return `
                <div class="card">
                    <div class="card-body">
                        <img src="data:image/gif;base64,${picture.data}" alt="">
                    </div>
                    <!-- /.card-body -->
                    <div class="card-footer d-none">
                        <p>${picture.type}</p>
                        <p>${picture.desciption}</p>
                    </div>
                    <!-- /.card-footer -->
                </div>
                <!-- /.card -->
            `;
        }


        function btnEditClick(data = responseData) {
            disableCard('#upload', 'Đang trong quá trình chỉnh sửa, tạm thời không thể thay đổi file đang chọn.');
            $('#upload').css('display', 'none');
            $('#metadata').css('display', 'none');
            $('#content').append(generalEditCard(data));
        }

        function generalEditCard(oldData = sampleData) {
            return `
            <div id="edit" class="card">
                <div class="card-header">
                    <h3 class="card-title">Chỉnh sửa siêu dữ liệu</h3>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                        <div class="form-group">
                            <label for="input-title">Tiêu đề</label>
                            <input type="text" name="title" class="form-control" id="input-title" value="${oldData.metadata.title}">
                        </div>
                        <div class="form-group">
                            <label for="input-artist">Ca sĩ</label>
                            <input type="text" name="artist" class="form-control" id="input-artist" value="${oldData.metadata.artist}">
                        </div>
                        <div class="form-group">
                            <label for="input-album">Album</label>
                            <input type="text" name="album" class="form-control" id="input-album" value="${oldData.metadata.album}">
                        </div>
                        <div class="form-group">
                            <label for="input-year">Năm phát hành</label>
                            <input type="text" name="year" class="form-control" id="input-date" value="${oldData.metadata.year}">
                        </div>
                        <div class="form-group">
                            <label for="input-tracknumber">Số thứ tự trong album</label>
                            <input type="number" name="tracknumber" class="form-control" id="input-tracknumber" value="${oldData.metadata.tracknumber}">
                        </div>
                        <div class="form-group">
                            <label for="input-totaltracks">Số bài trong album</label>
                            <input type="number" name="totaltracks" class="form-control" id="input-totaltracks" value="${oldData.metadata.totaltracks}">
                        </div>
                        <div class="form-group">
                            <label for="input-genre">Thể loại</label>
                            <input type="text" name="genre" class="form-control" id="input-genre" value="${oldData.metadata.genre}">
                        </div>
                    <div class="btn btn-primary" onclick="btnSaveEditClick()">Lưu</div>
                    <div class="btn btn-secondary" onclick="btnCancelEditClick()">Hủy</div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            `;
        }

        function btnSaveEditClick() {
            enableCard();
            $('#metadata').remove();
            disableCard('#edit', 'Đang xử lý, vui lòng chờ!');

            var form = new FormData();
            form.append('title', $('#input-title').val());
            form.append('artist', $('#input-artist').val());
            form.append('album', $('#input-album').val());
            form.append('date', $('#input-date').val());
            form.append('tracknumber', $('#input-tracknumber').val());
            form.append('totaltracks', $('#input-totaltracks').val());
            form.append('genre', $('#input-genre').val());
            form.append('file', fileHandling);
            $.ajax({
                method: 'POST',
                url: 'http://127.0.0.1:5000/api/edit-metadata-audio',
                data: form,
                contentType: false,
                processData: false,
                success: (res) => {
                    $('#edit').remove();
                    $('#upload').css('display', 'block');
                    console.log(res);
                    window.open(res, "_blank");
                }
            })
                .done(() => {
                    setTimeout(() => {
                        enableCard();
                    }, 2000);
                });
        }

        function btnCancelEditClick() {
            $('#upload').css('display', 'block');
            $('#metadata').css('display', 'block');
            $('#edit').remove();
            enableCard();
        }


        function generalLoadScreen() {
            return '<div class="overlay dark"><i class="fas fa-2x fa-sync-alt fa-spin"></i><div>';
        }

        function disableCard(card, mesg) {
            $(card).append(`<div class="overlay" onclick="alert('${mesg}')"> </div>`);
        }

        function enableCard(card) {
            if (!card) {
                $('.overlay').remove();
                return;
            }
            $(card).children('.overlay').remove();
        }
    </script>

</body>

</html>